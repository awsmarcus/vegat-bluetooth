#include <BluetoothSerial.h>

// Create a Bluetooth Serial object
BluetoothSerial SerialBT;

String password = "Hectronic";  // Fixed password for authentication
bool isAuthenticated = false;
bool hasPrompted = false;  // Flag to check if the prompt has been sent

void setup() {
  Serial.begin(115200);  // Initialize Serial communication
  delay(1000);  // Stabilize serial communication

  SerialBT.begin("ESP32_Bluetooth");  // Start Bluetooth with a device name
  delay(1000);  // Allow time for Bluetooth initialization

  Serial.println("Bluetooth started. Waiting for connection...");
}

void loop() {
  if (SerialBT.hasClient() && !isAuthenticated && !hasPrompted) {
    SerialBT.println("Enter password:");  // Prompt the user for password after connection
    hasPrompted = true;                   // Set the flag to true after sending the prompt
  }

  bluetoothAuthentication();
}

void bluetoothAuthentication() {
  if (SerialBT.available()) {
    String receivedMessage = SerialBT.readString();
    receivedMessage.trim();  // Remove leading/trailing spaces and invisible characters

    if (receivedMessage.isEmpty()) {
      return;  // Ignore invalid input
    }

    Serial.println("Received: " + receivedMessage);

    if (!isAuthenticated) {
      if (receivedMessage == password) {
        isAuthenticated = true;
        Serial.println("Authentication successful.");
        SerialBT.println("Authentication successful. You now have access.");
        
        // Call the Boolean function
        if (returnTrueAfterAuthentication()) {
          
        }
      } else {
        Serial.println("Invalid password. Access denied.");
        SerialBT.println("Invalid password. Please try again.");
        hasPrompted = false;  // Reset the flag to resend the prompt for retry
        
      }
    }
  }
}

// Boolean function to return true after successful authentication
bool returnTrueAfterAuthentication() {
  return isAuthenticated;  // Returns true if authentication is successful
}