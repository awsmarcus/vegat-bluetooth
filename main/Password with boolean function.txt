#include <BluetoothSerial.h>

// Create a Bluetooth Serial object
BluetoothSerial SerialBT;

String password = "Hectronic";  // Fixed password for authentication
bool isAuthenticated = false;
bool hasPrompted = false;

void setup() {
  Serial.begin(115200);            // Initialize Serial communication
  SerialBT.begin("ESP32_Bluetooth");  // Start Bluetooth with a device name
  Serial.println("Bluetooth started. Waiting for connection...");
}

void loop() {
  // Check if the client is connected
  if (!SerialBT.hasClient() && isAuthenticated) {
    Serial.println("Client disconnected. Resetting authentication.");
    isAuthenticated = false; // Reset authentication state
    hasPrompted = false;     // Reset the prompt flag
  }

  // Prompt for password if a new client connects and not authenticated
  if (SerialBT.hasClient() && !isAuthenticated && !hasPrompted) {
    SerialBT.println("Enter password:");
    hasPrompted = true;
  }

  bluetoothAuthentication();
}

void bluetoothAuthentication() {
  if (SerialBT.available()) {
    String receivedMessage = SerialBT.readString();
    receivedMessage.trim();  // Remove leading/trailing spaces

    if (receivedMessage.isEmpty()) {
      return;  // Ignore invalid input
    }

    Serial.println("Received: " + receivedMessage);

    if (!isAuthenticated) {
      if (receivedMessage == password) {
        isAuthenticated = true;
        Serial.println("Authentication successful.");
        SerialBT.println("Authentication successful. You now have access.");
      } else {
        Serial.println("Invalid password. Access denied.");
        SerialBT.println("Invalid password. Please try again.");
        hasPrompted = false;  // Allow retry by resetting the prompt flag
      }
    }
  }
}
